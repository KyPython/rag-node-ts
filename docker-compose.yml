# RAG-as-a-Service Development Stack
#
# Usage:
#   docker-compose up -d          # Start all services
#   docker-compose logs -f rag    # View RAG service logs
#   docker-compose down           # Stop all services
#
# For production, use docker-compose.prod.yml

version: '3.8'

services:
  # ============================================================================
  # Main RAG Service
  # ============================================================================
  rag:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${PORT:-3000}:3000"
    environment:
      # Required
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PINECONE_API_KEY=${PINECONE_API_KEY}
      - PINECONE_INDEX_NAME=${PINECONE_INDEX_NAME}
      
      # Optional configuration
      - PORT=3000
      - NODE_ENV=${NODE_ENV:-development}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - CACHE_TTL_SECONDS=${CACHE_TTL_SECONDS:-300}
      - MAX_CONTEXT_LENGTH=${MAX_CONTEXT_LENGTH:-8000}
      
      # Redis for distributed caching
      - REDIS_URL=redis://redis:6379
      
      # API keys
      - RAG_API_KEY=${RAG_API_KEY}
      - RAG_ADMIN_KEY=${RAG_ADMIN_KEY}
      - RAG_DEMO_API_KEY=${RAG_DEMO_API_KEY}
      
      # Tenant configurations (add as needed)
      - RAG_TENANT_EASYFLOW=${RAG_TENANT_EASYFLOW:-}
    
    depends_on:
      - redis
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    volumes:
      # Persist uploads between restarts
      - rag-uploads:/app/uploads

  # ============================================================================
  # Redis (Caching Layer)
  # ============================================================================
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Chroma vector database for local development
  chroma:
    image: ghcr.io/chroma-core/chroma:latest
    ports:
      - "8000:8000"
    environment:
      - CHROMA_SERVER_ALLOW_EMPTY_PASSWORD=true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/health"]
      interval: 20s
      timeout: 5s
      retries: 3

  # Simple static UI that serves files from ./public for demo purposes
  ui:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./public:/usr/share/nginx/html:ro
    restart: unless-stopped

# ============================================================================
# Volumes
# ============================================================================
volumes:
  rag-uploads:
  redis-data:

# ============================================================================
# Networks (optional - for connecting to other services)
# ============================================================================
networks:
  default:
    name: rag-network

